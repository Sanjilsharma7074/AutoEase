<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Rental Service - Admin Dashboard</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8" />
                    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                    <title>AutoLease - Admin</title>
                    <link rel="stylesheet" href="/css/style.css" />
                    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
                </head>
                <body>
                    <nav class="navbar">
                        <div class="nav-container">
                            <div class="nav-logo"><a href="/"><i class="fas fa-car"></i> AutoLease</a></div>
                            <ul class="nav-menu">
                                <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                                <li class="nav-item"><a class="nav-link" href="/cars">Cars</a></li>
                                <li class="nav-item" id="bookings-link" style="display:none"><a class="nav-link" href="/bookings">My Bookings</a></li>
                                <li class="nav-item"><a class="nav-link" href="/login">Login</a></li>
                                <li class="nav-item"><a class="nav-link" href="/signup">Sign Up</a></li>
                            </ul>
                            <div class="hamburger" aria-hidden="true"><span class="bar"></span><span class="bar"></span><span class="bar"></span></div>
                        </div>
                    </nav>

                    <main class="container" style="padding-top:36px">
                        <div class="section-header" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
                            <h2>Admin Dashboard</h2>
                            <div>
                                <button class="tab-button active" onclick="openTab(event,'cars-tab')">Manage Cars</button>
                                <button class="tab-button" onclick="openTab(event,'bookings-tab')">All Bookings</button>
                            </div>
                        </div>

                        <div id="cars-tab" class="tab-content active">
                            <div class="section-header">
                                <h3>Car Management</h3>
                                <button class="btn btn-primary" onclick="openAddCarModal()">Add New Car</button>
                            </div>
                            <div id="adminCarsContainer" class="admin-cars-grid"></div>
                        </div>

                        <div id="bookings-tab" class="tab-content">
                            <div class="section-header"><h3>All Bookings</h3></div>
                            <div id="adminBookingsContainer"></div>
                        </div>
                    </main>

                    <!-- Add Car Modal -->
                    <div id="addCarModal" class="modal">
                        <div class="modal-content">
                            <span class="close">&times;</span>
                            <h2>Add New Car</h2>
                            <div id="addCarMessage" class="message"></div>
                            <form id="addCarForm">
                                <div class="form-group">
                                    <label for="model">Car Model:</label>
                                    <input type="text" id="model" name="model" required>
                                </div>
                                <div class="form-group">
                                    <label for="type">Car Type:</label>
                                    <select id="type" name="type" required>
                                        <option value="">Select Type</option>
                                        <option value="sedan">Sedan</option>
                                        <option value="suv">SUV</option>
                                        <option value="hatchback">Hatchback</option>
                                        <option value="luxury">Luxury</option>
                                        <option value="coupe">Coupe</option>
                                        <option value="convertible">Convertible</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="pricePerDay">Price Per Day ($):</label>
                                    <input type="number" id="pricePerDay" name="pricePerDay" min="1" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label for="imageUrl">Car Image URL:</label>
                                    <input type="url" id="imageUrl" name="imageUrl" placeholder="Enter image URL">
                                    <div style="margin-top:10px;">
                                        <small>Sample images (click to use):</small>
                                        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px">
                                            <img src="https://images.unsplash.com/photo-1549924231-f129b911e442?q=80&w=400&auto=format&fit=crop" onclick="document.getElementById('imageUrl').value=this.src" style="cursor:pointer;border-radius:3px;width:60px;height:40px;object-fit:cover">
                                            <img src="https://images.unsplash.com/photo-1552519507-da3b142c6e3d?q=80&w=400&auto=format&fit=crop" onclick="document.getElementById('imageUrl').value=this.src" style="cursor:pointer;border-radius:3px;width:60px;height:40px;object-fit:cover">
                                            <img src="https://images.unsplash.com/photo-1583121274602-3e2820c69888?q=80&w=400&auto=format&fit=crop" onclick="document.getElementById('imageUrl').value=this.src" style="cursor:pointer;border-radius:3px;width:60px;height:40px;object-fit:cover">
                                            <img src="https://images.unsplash.com/photo-1544636331-e26879cd4d9b?q=80&w=400&auto=format&fit=crop" onclick="document.getElementById('imageUrl').value=this.src" style="cursor:pointer;border-radius:3px;width:60px;height:40px;object-fit:cover">
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">Add Car</button>
                            </form>
                        </div>
                    </div>

                    <footer class="site-footer">&copy; 2025 AutoLease</footer>

                    <script src="/js/main.js"></script>
                    <script>
                        function openTab(e, id){
                            document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
                            e.currentTarget.classList.add('active');
                            document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
                            document.getElementById(id).classList.add('active');
                        }
                        function openAddCarModal(){ document.getElementById('addCarModal').style.display='block'; }
                        document.addEventListener('click', function(ev){ if(ev.target.matches('.close')) document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); });
                    </script>
                </body>
                </html>

function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].classList.remove("active");
    }
    tablinks = document.getElementsByClassName("tab-button");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].classList.remove("active");
    }
    document.getElementById(tabName).classList.add("active");
    evt.currentTarget.classList.add("active");
}

async function loadAdminCars() {
    try {
        const response = await fetch('/api/cars');
        const cars = await response.json();
        displayAdminCars(cars);
    } catch (error) {
        console.error('Error loading cars:', error);
    }
}

function displayAdminCars(cars) {
    const container = document.getElementById('adminCarsContainer');
    
    container.innerHTML = cars.map(car => `
        <div class="admin-car-card">
            ${car.imageUrl ? `<div class="car-image" style="text-align: center; margin-bottom: 10px;">
                <img src="${car.imageUrl}" alt="${car.model}" style="max-width: 100%; height: 150px; object-fit: cover; border-radius: 5px;">
            </div>` : ''}
            <div class="car-details">
                <h3>${car.model}</h3>
                <p><strong>Type:</strong> ${car.type}</p>
                <p><strong>Price:</strong> $${car.pricePerDay}/day</p>
                <p><strong>Status:</strong> 
                    <span class="status-${car.availability ? 'available' : 'unavailable'}">
                        ${car.availability ? 'Available' : 'Not Available'}
                    </span>
                </p>
            </div>
            <div class="car-actions">
                <button class="btn btn-primary btn-sm" onclick="editCar('${car._id}')">Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteCar('${car._id}')">Delete</button>
            </div>
        </div>
    `).join('');
}

async function loadAdminBookings() {
    const token = localStorage.getItem('token');
    
    try {
        const response = await fetch('/api/bookings/all', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        const bookings = await response.json();
        displayAdminBookings(bookings);
    } catch (error) {
        console.error('Error loading bookings:', error);
    }
}

function displayAdminBookings(bookings) {
    const container = document.getElementById('adminBookingsContainer');
    
    if (bookings.length === 0) {
        container.innerHTML = '<div class="no-bookings">No bookings found</div>';
        return;
    }
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    container.innerHTML = bookings.map(booking => {
        const startDate = new Date(booking.startDate);
        const endDate = new Date(booking.endDate);
        startDate.setHours(0, 0, 0, 0);
        endDate.setHours(0, 0, 0, 0);
        
        // Check if booking is currently in progress (customer has the car)
        const isInProgress = booking.status === 'booked' && today >= startDate && today <= endDate;
        
        return `
        <div class="admin-booking-card">
            <div class="booking-details">
                <h3>${booking.carId?.model || 'Unknown Car'}</h3>
                <p><strong>Customer:</strong> ${booking.userId?.name || booking.customerName || 'Unknown User'}</p>
                <p><strong>Email:</strong> ${booking.userId?.email || booking.customerEmail || 'N/A'}</p>
                <p><strong>Start Date:</strong> ${new Date(booking.startDate).toLocaleDateString()}</p>
                <p><strong>End Date:</strong> ${new Date(booking.endDate).toLocaleDateString()}</p>
                <p><strong>Status:</strong> <span class="status-${booking.status}">${booking.status}</span></p>
                ${isInProgress ? '<p style="color: #e74c3c; font-weight: bold;"><i class="fas fa-car"></i> Customer currently using this vehicle</p>' : ''}
            </div>
            <div class="booking-actions">
                ${booking.status === 'booked' && !isInProgress ? 
                    `<button class="btn btn-danger btn-sm" onclick="cancelBookingAdmin('${booking._id}')">Cancel</button>` :
                    isInProgress ?
                    `<button class="btn btn-disabled btn-sm" disabled title="Cannot cancel while customer is using the car">In Progress</button>` :
                    ''
                }
            </div>
        </div>
        `;
    }).join('');
}

function openAddCarModal() {
    document.getElementById('addCarModal').style.display = 'block';
}

// Close modal
document.querySelector('.close').onclick = function() {
    document.getElementById('addCarModal').style.display = 'none';
}

// Handle add car form
document.getElementById('addCarForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const token = localStorage.getItem('token');
    const formData = new FormData(e.target);
    const carData = {
        model: formData.get('model'),
        type: formData.get('type'),
        pricePerDay: parseInt(formData.get('pricePerDay')),
        imageUrl: formData.get('imageUrl')
    };
    
    const messageDiv = document.getElementById('addCarMessage');
    
    try {
        const response = await fetch('/api/cars', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(carData)
        });
        
        if (response.ok) {
            messageDiv.innerHTML = '<div class="success">Car added successfully!</div>';
            setTimeout(() => {
                document.getElementById('addCarModal').style.display = 'none';
                loadAdminCars();
                e.target.reset();
                messageDiv.innerHTML = '';
            }, 2000);
        } else {
            messageDiv.innerHTML = '<div class="error">Failed to add car</div>';
        }
    } catch (error) {
        messageDiv.innerHTML = '<div class="error">Network error</div>';
    }
});

async function deleteCar(carId) {
    if (!confirm('Are you sure you want to delete this car?')) {
        return;
    }
    
    const token = localStorage.getItem('token');
    
    try {
        const response = await fetch(`/api/cars/${carId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            alert('Car deleted successfully');
            loadAdminCars();
        } else {
            alert('Failed to delete car');
        }
    } catch (error) {
        alert('Error deleting car');
    }
}

async function cancelBookingAdmin(bookingId) {
    if (!confirm('Are you sure you want to cancel this booking?')) {
        return;
    }
    
    const token = localStorage.getItem('token');
    
    try {
        const response = await fetch(`/api/bookings/cancel/${bookingId}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            alert('Booking cancelled successfully');
            loadAdminBookings();
        } else {
            alert('Failed to cancel booking');
        }
    } catch (error) {
        alert('Error cancelling booking');
    }
}

function editCar(carId) {
    window.location.href = `/edit-car?id=${carId}`;
}
</script>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-container">
            <p>&copy; 2025 Car Rental Service. All rights reserved.</p>
        </div>
    </footer>

    <script src="/js/auth.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/main.js"></script>
</body>
</html>