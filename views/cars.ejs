<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AutoEase - Cars</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <nav class="navbar">
      <div class="nav-container">
        <div class="nav-logo">
          <a href="/"><i class="fas fa-car-side"></i> AutoEase</a>
        </div>
        <ul class="nav-menu">
          <li class="nav-item">
            <a href="/" class="nav-link">Home</a>
          </li>
          <li class="nav-item">
            <a href="/cars" class="nav-link">Cars</a>
          </li>
          <li class="nav-item" id="bookings-link" style="display: none">
            <a href="/bookings" class="nav-link">My Bookings</a>
          </li>
          <li class="nav-item" id="admin-link" style="display: none">
            <a href="/admin" class="nav-link">Admin</a>
          </li>
          <li class="nav-item" id="superadmin-link" style="display: none">
            <a href="/superadmin" class="nav-link">Super Admin</a>
          </li>
          <li class="nav-item" id="login-link">
            <a href="/login" class="nav-link">Login</a>
          </li>
          <li class="nav-item" id="signup-link">
            <a href="/signup" class="nav-link">Sign Up</a>
          </li>
          <li class="nav-item" id="logout-link" style="display: none">
            <a href="#" class="nav-link" onclick="logout()">Logout</a>
          </li>
        </ul>
        <div class="hamburger">
          <span class="bar"></span>
          <span class="bar"></span>
          <span class="bar"></span>
        </div>
      </div>
    </nav>

    <main>
      <div class="container">
        <!-- Hero: Available Cars -->
        <section class="cars-hero">
          <div class="hero-inner">
            <h1 class="cars-hero-title">
              Available Cars
              <span class="title-underline"></span>
            </h1>
            <p class="cars-hero-subtitle">
              Find the perfect ride for any occasion — luxury, comfort, and
              performance curated for you.
            </p>
          </div>
          <div class="hero-shape hero-shape-a"></div>
          <div class="hero-shape hero-shape-b"></div>
        </section>

        <!-- Filters: chips + price -->
        <section class="filter-bar">
          <div class="filter-left">
            <label class="price-label">Model:</label>
            <select id="modelFilter" class="model-filter">
              <option value="">All Models</option>
            </select>
          </div>
          <div class="filter-right">
            <label class="price-label"
              >Max Price: <span id="priceValue">$0</span></label
            >
            <input
              type="range"
              id="priceRange"
              min="0"
              max="500"
              value="500"
              step="10"
            />
          </div>
        </section>

        <div id="carsContainer" class="cars-grid">
          <!-- Cars will be loaded here -->
        </div>

        <div id="loading" class="loading">Loading cars...</div>
      </div>

      <!-- Booking Modal -->
      <div id="bookingModal" class="modal">
        <div class="modal-content">
          <span class="close">&times;</span>
          <h2>Book This Car</h2>
          <div id="bookingMessage" class="message"></div>
          <form id="bookingForm">
            <input type="hidden" id="carId" name="carId" />
            <div class="form-group">
              <label for="startDate">Start Date:</label>
              <input type="date" id="startDate" name="startDate" required />
            </div>
            <div class="form-group">
              <label for="endDate">End Date:</label>
              <input type="date" id="endDate" name="endDate" required />
            </div>
            <div class="form-group">
              <label for="pickupLocation">Pickup Location (address):</label>
              <input
                type="text"
                id="pickupLocation"
                name="pickupLocation"
                placeholder="e.g. 123 Main St, City"
                required
              />
            </div>
            <div class="form-group">
              <label for="dropoffLocation">Drop-off Location (address):</label>
              <input
                type="text"
                id="dropoffLocation"
                name="dropoffLocation"
                placeholder="e.g. 456 Other St, City"
                required
              />
            </div>
            <div class="form-group">
              <label>Route Preview:</label>
              <div id="routePreview">
                Enter pickup and drop-off to preview route and distance
              </div>
            </div>
            <div class="form-group">
              <label>Total Cost:</label>
              <div id="totalCost">$0</div>
            </div>
            <button type="submit" class="btn btn-primary">Book Now</button>
          </form>
        </div>
      </div>

      <script>
        let allCars = [];
        let maxPrice = 500;
        let selectedModel = "";

        // Load cars on page load
        document.addEventListener("DOMContentLoaded", function () {
          loadCars();

          // Price range
          const range = document.getElementById("priceRange");
          const priceValue = document.getElementById("priceValue");
          range.addEventListener("input", () => {
            maxPrice = Number(range.value);
            priceValue.textContent = `$${maxPrice}`;
            applyFilters();
          });

          // Model filter
          document
            .getElementById("modelFilter")
            .addEventListener("change", (e) => {
              selectedModel = e.target.value;
              applyFilters();
            });
        });

        async function loadCars() {
          try {
            const response = await fetch("/api/cars");
            allCars = await response.json();
            // Initialize price slider to max observed price
            const highest = Math.max(...allCars.map((c) => c.pricePerDay), 0);
            const range = document.getElementById("priceRange");
            range.max = highest || 500;
            range.value = highest || 500;
            maxPrice = Number(range.value);
            document.getElementById("priceValue").textContent = `$${maxPrice}`;

            // Populate model filter
            const modelSelect = document.getElementById("modelFilter");
            const models = Array.from(
              new Set(allCars.map((c) => c.model))
            ).sort();
            // clear existing except first
            while (modelSelect.options.length > 1) modelSelect.remove(1);
            models.forEach((m) => {
              const opt = document.createElement("option");
              opt.value = m;
              opt.textContent = m;
              modelSelect.appendChild(opt);
            });

            displayCars(allCars);
            document.getElementById("loading").style.display = "none";
          } catch (error) {
            document.getElementById("loading").innerHTML = "Error loading cars";
          }
        }

        function applyFilters() {
          const filtered = allCars.filter((car) => {
            const matchesModel = !selectedModel || car.model === selectedModel;
            const matchesPrice = Number(car.pricePerDay) <= maxPrice;
            return matchesModel && matchesPrice;
          });
          displayCars(filtered);
        }

        function displayCars(cars) {
          const container = document.getElementById("carsContainer");
          const defaultImage = "https://placehold.co/600x360?text=Car+Image"; // Reliable fallback image

          if (cars.length === 0) {
            container.innerHTML =
              '<div class="no-cars">No cars available</div>';
            return;
          }

          container.innerHTML = cars
            .map((car) => {
              const image = car.imageUrl || defaultImage;
              const rating = Number(car.rating || 4.7);
              const fullStars = Math.floor(rating);
              const halfStar = rating - fullStars >= 0.5;
              const badge =
                car.badge ||
                (car.pricePerDay <= 50
                  ? "Best Deal"
                  : car.type === "Luxury"
                  ? "Popular"
                  : "");
              const discount = Number(car.discountPercent || 0);
              const price = Number(car.pricePerDay);
              const discounted =
                discount > 0
                  ? Math.max(1, Math.round(price - (price * discount) / 100))
                  : price;
              const availabilityText = car.availability
                ? "Available Today"
                : "Not Available";
              const availabilityClass = car.availability
                ? "available"
                : "unavailable";

              const starsHtml = `${"\n"}${Array.from({ length: fullStars })
                .map(() => '<i class="fas fa-star"></i>')
                .join("")}${
                halfStar ? '<i class="fas fa-star-half-alt"></i>' : ""
              }${Array.from({ length: 5 - fullStars - (halfStar ? 1 : 0) })
                .map(() => '<i class="far fa-star"></i>')
                .join("")}`;

              return `
            <div class="car-card modern">
              ${
                badge
                  ? `<span class="car-badge ${
                      badge === "Best Deal" ? "deal" : "popular"
                    }">${badge}</span>`
                  : ""
              }
              <div class="car-image zoomable">
                <img src="${image}" alt="${
                car.model
              }" onerror="this.onerror=null;this.src='${defaultImage}';">
              </div>
              <div class="car-info">
                <div class="car-header">
                  <h3>${car.model}</h3>
                  <span class="car-type">${car.type}</span>
                </div>
                <div class="rating">${starsHtml}<span class="rating-number">${rating.toFixed(
                1
              )}</span></div>
                <div class="car-features">
                  <span class="feature-tag"><i class="fas fa-users"></i> 4-5 Seats</span>
                  <span class="feature-tag"><i class="fas fa-cog"></i> Automatic</span>
                  <span class="feature-tag"><i class="fas fa-gas-pump"></i> Gasoline</span>
                  <span class="feature-tag"><i class="fas fa-snowflake"></i> AC</span>
                  <span class="feature-tag"><i class="fas fa-suitcase"></i> 3 Luggage</span>
                  <span class="feature-tag"><i class="fas fa-door-open"></i> 4 Doors</span>
                </div>
                <div class="price-row">
                  ${
                    discount > 0
                      ? `<span class="price-old">$${price}</span>`
                      : ""
                  }
                  <span class="price-now">$${discounted}</span><span class="price-period">/day</span>
                  ${
                    discount > 0
                      ? `<span class="discount-badge">-${discount}%</span>`
                      : ""
                  }
                </div>
                <div class="availability ${availabilityClass}">
                  <span class="dot"></span>
                  <span>${availabilityText}</span>
                </div>
              </div>
              <div class="car-actions">
                ${
                  car.availability
                    ? `
                <button class="btn-book" onclick="bookNow('${car._id}','${car.model}',${price})">Book Now</button>
                `
                    : `
                <button class="btn-disabled" disabled>Not Available</button>
                `
                }
                <button class="btn-secondary" onclick="viewDetails('${
                  car._id
                }')">View Details</button>
              </div>
            </div>`;
            })
            .join("");
        }

        function formatDate(dateString) {
          return new Date(dateString).toLocaleDateString("en-US", {
            year: "numeric",
            month: "short",
            day: "numeric",
          });
        }

        // Optional navigation for details
        function viewDetails(id) {
          window.location.hash = `car-${id}`;
        }

        function bookNow(carId, carModel, pricePerDay) {
          if (!isLoggedIn()) {
            alert("Please login to book a car");
            window.location.href = "/login";
            return;
          }

          document.getElementById("carId").value = carId;
          document.getElementById("bookingModal").style.display = "block";

          // Button loading animation
          const btn = Array.from(document.querySelectorAll(".btn-book")).find(
            (b) => b.onclick && b.onclick.toString().includes(carId)
          );
          if (btn) {
            btn.classList.add("loading");
            setTimeout(() => btn.classList.remove("loading"), 1200);
          }

          // Calculate total cost when dates change
          const startDate = document.getElementById("startDate");
          const endDate = document.getElementById("endDate");

          function calculateCost() {
            if (startDate.value && endDate.value) {
              const start = new Date(startDate.value);
              const end = new Date(endDate.value);
              const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));

              if (days > 0) {
                const total = days * pricePerDay;
                document.getElementById("totalCost").textContent = `$${total}`;
              }
            }
          }

          startDate.addEventListener("change", calculateCost);
          endDate.addEventListener("change", calculateCost);
        }

        // Close modal
        document.querySelector(".close").onclick = function () {
          document.getElementById("bookingModal").style.display = "none";
        };

        window.onclick = function (event) {
          const modal = document.getElementById("bookingModal");
          if (event.target == modal) {
            modal.style.display = "none";
          }
        };

        // Handle booking form submission
        document
          .getElementById("bookingForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();

            const token = localStorage.getItem("token");
            if (!token) {
              alert("Please login first");
              return;
            }

            const formData = new FormData(e.target);
            const pickupLocation = formData.get("pickupLocation");
            const dropoffLocation = formData.get("dropoffLocation");

            async function geocode(address) {
              const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(
                address
              )}`;
              try {
                const res = await fetch(url, {
                  headers: { Accept: "application/json" },
                });
                const arr = await res.json();
                if (arr && arr.length > 0) {
                  return {
                    lat: parseFloat(arr[0].lat),
                    lng: parseFloat(arr[0].lon),
                  };
                }
              } catch (err) {
                console.error("Geocode error", err);
              }
              return null;
            }

            function haversineKm(a, b) {
              const toRad = (v) => (v * Math.PI) / 180;
              const R = 6371; // km
              const dLat = toRad(b.lat - a.lat);
              const dLon = toRad(b.lng - a.lng);
              const lat1 = toRad(a.lat);
              const lat2 = toRad(b.lat);

              const sinDLat = Math.sin(dLat / 2) * Math.sin(dLat / 2);
              const sinDLon = Math.sin(dLon / 2) * Math.sin(dLon / 2);
              const aCalc = sinDLat + Math.cos(lat1) * Math.cos(lat2) * sinDLon;
              const c = 2 * Math.atan2(Math.sqrt(aCalc), Math.sqrt(1 - aCalc));
              return R * c;
            }

            const bookingData = {
              carId: formData.get("carId"),
              startDate: formData.get("startDate"),
              endDate: formData.get("endDate"),
              pickupLocation,
              dropoffLocation,
            };

            // Geocode addresses and compute distance (best-effort using Nominatim)
            let pickupCoord = null;
            let dropoffCoord = null;
            try {
              pickupCoord = await geocode(pickupLocation);
              dropoffCoord = await geocode(dropoffLocation);
            } catch (err) {
              console.warn("Geocoding failed", err);
            }

            if (pickupCoord && dropoffCoord) {
              const km = haversineKm(pickupCoord, dropoffCoord);
              bookingData.pickupLat = pickupCoord.lat;
              bookingData.pickupLng = pickupCoord.lng;
              bookingData.dropoffLat = dropoffCoord.lat;
              bookingData.dropoffLng = dropoffCoord.lng;
              bookingData.distanceKm = Math.round(km * 100) / 100; // two decimals

              // Update route preview
              const origin = encodeURIComponent(pickupLocation);
              const dest = encodeURIComponent(dropoffLocation);
              const mapsLink = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}`;
              document.getElementById(
                "routePreview"
              ).innerHTML = `Distance: <strong>${bookingData.distanceKm} km</strong> — <a href="${mapsLink}" target="_blank">Open in Google Maps</a>`;
            } else {
              document.getElementById("routePreview").textContent =
                "Could not determine exact route/distance (geocoding failed). A map link will still be provided.";
            }

            const messageDiv = document.getElementById("bookingMessage");

            try {
              const response = await fetch("/api/bookings", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify(bookingData),
              });

              const data = await response.json();

              if (response.ok) {
                messageDiv.innerHTML =
                  '<div class="success">Booking successful!</div>';
                setTimeout(() => {
                  document.getElementById("bookingModal").style.display =
                    "none";
                  loadCars(); // Reload cars to reflect updated availability
                }, 2000);
              } else {
                messageDiv.innerHTML = `<div class="error">${
                  data.message || "Booking failed"
                }</div>`;
              }
            } catch (error) {
              messageDiv.innerHTML =
                '<div class="error">Network error. Please try again.</div>';
            }
          });
      </script>
    </main>

    <footer class="footer">
      <div class="footer-container">
        <p>&copy; 2025 AutoEase. All rights reserved.</p>
      </div>
    </footer>

    <script src="/js/auth.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/main.js"></script>
  </body>
</html>
