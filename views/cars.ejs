<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#0b76ff" />
    <title>AutoLease - Cars</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  </head>
  <body>
    <nav class="navbar">
      <div class="nav-container">
        <div class="nav-logo">
          <a href="/"><i class="fas fa-car"></i> AutoLease</a>
        </div>
        <ul class="nav-menu">
          <li class="nav-item">
            <a href="/" class="nav-link">Home</a>
          </li>
          <li class="nav-item">
            <a href="/cars" class="nav-link">Cars</a>
          </li>
          <li class="nav-item" id="bookings-link" style="display: none">
            <a href="/bookings" class="nav-link">My Bookings</a>
          </li>
          <li class="nav-item" id="admin-link" style="display: none">
            <a href="/admin" class="nav-link">Admin</a>
          </li>
          <li class="nav-item" id="superadmin-link" style="display: none">
            <a href="/superadmin" class="nav-link">Super Admin</a>
          </li>
          <li class="nav-item" id="login-link">
            <a href="/login" class="nav-link">Login</a>
          </li>
          <li class="nav-item" id="signup-link">
            <a href="/signup" class="nav-link">Sign Up</a>
          </li>
          <li class="nav-item" id="logout-link" style="display: none">
            <a href="#" class="nav-link" onclick="logout()">Logout</a>
          </li>
        </ul>
        <div class="hamburger">
          <span class="bar"></span>
          <span class="bar"></span>
          <span class="bar"></span>
        </div>
      </div>
    </nav>

    <main>
      <div class="container">
        <div class="page-header">
          <h1 style="font-size: 50px;font-family:'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif ;">Available Cars</h1>
          <p style="font-style: italic;margin-left: -10px;">Find your perfect ride — filtered to your needs.</p>
        </div>

        <div class="layout-grid">
          <aside class="sidebar-filter">
            <h3 style="margin-top:0">Filters</h3>
            <div class="filter-section">
              <div class="filter-controls">
                <label><strong>Type</strong></label>
                <select id="typeFilter">
                  <option value="">All Types</option>
                </select>

                <label style="margin-top:0px"><strong>Price</strong></label>
                <select id="priceFilter">
                  <option value="">Any</option>
                  <option value="0-50">$0 - $50</option>
                  <option value="50-100">$50 - $100</option>
                  <option value="100-99999">$100+</option>
                </select>

                <label style="margin-top:0px"><strong>Location</strong></label>
                <input id="locationInput" type="text" placeholder="City or area" />
                <div class="filter-row" style="margin-top:8px">
                  <button class="btn-apply" onclick="applyLocationFilter()">Search</button>
                  <button class="btn-reset" onclick="detectLocationAndFilter()" style="margin-right: 15px;">Use my location</button>
                </div>

                <!-- <label style="margin-top:12px"><strong>Nearby</strong></label>
                <div class="filter-row">
                  <input id="radiusKm" type="number" min="1" max="200" placeholder="km" />
                  <select id="radiusUnit"><option value="km">km</option></select>
                </div> -->

                <div style="margin-top:8px;display:flex;gap:8px">
                  <button class="btn-apply" onclick="applyRadiusAndFilters()" style="background-color: green;">Apply</button>
                  <button class="btn-reset" onclick="resetFilters()" >Reset</button>
                </div>
              </div>
            </div>
          </aside>

          <section>
              <div id="carsContainer" class="cards-grid">
                <!-- Cars will be loaded here -->
              </div>

            <div id="loading" class="loading skeleton-cards">
          <div class="skeleton-card">
            <div class="skeleton-img skeleton"></div>
            <div class="skeleton-line skeleton" style="width:60%"></div>
            <div class="skeleton-line skeleton" style="width:40%"></div>
            <div class="skeleton-line skeleton" style="width:80%"></div>
          </div>
          <div class="skeleton-card">
            <div class="skeleton-img skeleton"></div>
            <div class="skeleton-line skeleton" style="width:50%"></div>
            <div class="skeleton-line skeleton" style="width:30%"></div>
            <div class="skeleton-line skeleton" style="width:70%"></div>
          </div>
          <div class="skeleton-card">
            <div class="skeleton-img skeleton"></div>
            <div class="skeleton-line skeleton" style="width:65%"></div>
            <div class="skeleton-line skeleton" style="width:45%"></div>
            <div class="skeleton-line skeleton" style="width:85%"></div>
          </div>
        </div>
      </div>

      <!-- Booking Modal -->
      <div id="bookingModal" class="modal">
        <div class="modal-content">
          <span class="close">&times;</span>
          <h2>Book This Car</h2>
          <div id="bookingMessage" class="message"></div>
          <form id="bookingForm">
            <input type="hidden" id="carId" name="carId" />
            <div class="form-group">
              <label for="startDate">Start Date:</label>
              <input type="date" id="startDate" name="startDate" required />
            </div>
            <div class="form-group">
              <label for="endDate">End Date:</label>
              <input type="date" id="endDate" name="endDate" required />
            </div>
            <div class="form-group">
              <label for="pickupLocation">Pickup Location (address):</label>
              <input
                type="text"
                id="pickupLocation"
                name="pickupLocation"
                placeholder="e.g. 123 Main St, City"
                required
              />
            </div>
            <div class="form-group">
              <label for="dropoffLocation">Drop-off Location (address):</label>
              <input
                type="text"
                id="dropoffLocation"
                name="dropoffLocation"
                placeholder="e.g. 456 Other St, City"
                required
              />
            </div>
            <div class="form-group">
              <label>Route Preview:</label>
              <div id="routePreview">
                Enter pickup and drop-off to preview route and distance
              </div>
            </div>
            <div class="form-group">
              <label>Total Cost:</label>
              <div id="totalCost">$0</div>
            </div>
            <button type="submit" class="btn btn-primary">Book Now</button>
          </form>
        </div>
      </div>

      <script>
        let allCars = [];
        let currentStartDate = "";
        let currentEndDate = "";

        // Load cars on page load
        document.addEventListener("DOMContentLoaded", function () {
          loadCars();

          // Populate type filter options from server
          loadTypes();

          // Guard date inputs (if present) and set minimums
          const today = new Date().toISOString().split("T")[0];
          const startEl = document.getElementById("filterStartDate");
          const endEl = document.getElementById("filterEndDate");
          if (startEl && endEl) {
            startEl.min = today;
            endEl.min = today;
            startEl.addEventListener("change", function () {
              const startDate = this.value;
              if (startDate && endEl) {
                endEl.min = startDate;
              }
            });
          }
        });

        async function loadCars(startDate = "", endDate = "") {
          try {
            let url = "/api/cars";
            if (startDate && endDate) {
              url += `?startDate=${startDate}&endDate=${endDate}`;
              currentStartDate = startDate;
              currentEndDate = endDate;
            }

            const response = await fetch(url);
            allCars = await response.json();
            displayCars(allCars);
            document.getElementById("loading").style.display = "none";
          } catch (error) {
            document.getElementById("loading").innerHTML = "Error loading cars";
          }
        }

        async function checkAvailability() {
          const startEl = document.getElementById("filterStartDate");
          const endEl = document.getElementById("filterEndDate");
          if(!startEl || !endEl){
            alert('Date filters are not available');
            return;
          }
          const startDate = startEl.value;
          const endDate = endEl.value;

          if (!startDate || !endDate) {
            alert("Please select both start and end dates");
            return;
          }

          if (new Date(startDate) >= new Date(endDate)) {
            alert("End date must be after start date");
            return;
          }

          document.getElementById("loading").style.display = "block";
          await loadCars(startDate, endDate);

          // Update the booking modal with selected dates
          document.getElementById("startDate").value = startDate;
          document.getElementById("endDate").value = endDate;
        }

        function displayCars(cars) {
          const container = document.getElementById("carsContainer");
          const defaultImage = "https://placehold.co/600x360?text=Car+Image"; // Reliable fallback image

          if (cars.length === 0) {
            container.innerHTML =
              '<div class="no-cars">No cars available</div>';
            return;
          }

          container.innerHTML = cars
            .map((car, idx) => {
              const sampleImages = [
                'https://images.unsplash.com/photo-1511919884226-fd3cad34687c?auto=format&fit=crop&w=1400&q=80',
                'https://images.unsplash.com/photo-1502877338535-766e1452684a?auto=format&fit=crop&w=1400&q=80',
                'https://images.unsplash.com/photo-1542367597-0a3d7c8a8a8e?auto=format&fit=crop&w=1400&q=80',
                'https://images.unsplash.com/photo-1503376780353-7e6692767b70?auto=format&fit=crop&w=1400&q=80',
                'https://images.unsplash.com/photo-1525609004556-c46c7d6cf023?auto=format&fit=crop&w=1400&q=80'
              ];
              const defaultImageForIdx = sampleImages[idx % sampleImages.length];
              const imageSrc = car.imageUrl || defaultImageForIdx;
              const desc = car.description ? `<p class="car-desc">${car.description}</p>` : '';
              const badges = (car.features || []).slice(0,3).map(f => `<span class="badge">${f}</span>`).join(' ');
              return `
        <article class="card reveal" role="article" aria-label="${car.model}">
          <img class="media" src="${imageSrc}" alt="${car.model}" onerror="this.onerror=null;this.src='${defaultImageForIdx}';">
          <div class="card-body">
            <h3>${car.model}</h3>
            <div class="meta-row"><span class="car-type">${car.type}</span><strong class="car-price">$${car.pricePerDay}/day</strong></div>
            ${desc}
            <div class="badges">${badges}</div>
            <div class="meta">
              <div class="availability">${car.availability ? '<span class="badge">Available</span>' : '<span class="badge" style="background:rgba(231,76,60,0.08);color:#E74C3C">Unavailable</span>'}</div>
              <div class="actions">
                ${car.availability ? `<button class="btn-apply" onclick="openBookingModal('${car._id}', '${car.model}', ${car.pricePerDay})">Book</button>` : `<button class="btn-reset" disabled>Unavailable</button>`}
                <button class="btn-reset" onclick="openDetailsModal('${car._id}')">Details</button>
              </div>
            </div>
          </div>
        </article>`
            })
            .join('');
        }

          // Add event delegation for Details buttons and details modal rendering

        function formatDate(dateString) {
          return new Date(dateString).toLocaleDateString("en-US", {
            year: "numeric",
            month: "short",
            day: "numeric",
          });
        }

        async function loadTypes() {
          try {
            const res = await fetch("/api/cars/types");
            const types = await res.json();
            const select = document.getElementById("typeFilter");

            // Preserve the first "All Types" option, then add fetched types
            // Clear any existing non-default options
            while (select.options.length > 1) {
              select.remove(1);
            }

            types.forEach((type) => {
              const opt = document.createElement("option");
              opt.value = type; // use exact type string
              opt.textContent = type;
              select.appendChild(opt);
            });
          } catch (err) {
            console.error("Failed to load car types", err);
          }
        }

        function filterCars() {
          const typeFilter = document.getElementById("typeFilter").value;
          const locationFilter = (document.getElementById('locationInput')?.value || '').trim();
          const priceFilter = (document.getElementById('priceFilter')?.value || '').trim();

          let filteredCars = allCars;

          if (typeFilter) {
            filteredCars = allCars.filter((car) => car.type === typeFilter);
          }

          if(locationFilter){
            const loc = locationFilter.toLowerCase();
            filteredCars = filteredCars.filter(car=>{
              if(!car.areas || car.areas.length===0) return false;
              return car.areas.some(a=>{
                const al = a.toLowerCase();
                return al.includes(loc) || loc.includes(al) || loc.split(/[,\s]+/).some(tok=>al.includes(tok));
              });
            });
          }

          // price filter simple ranges
          if(priceFilter){
            const [min,max] = priceFilter.split('-').map(Number);
            filteredCars = filteredCars.filter(c=>{
              const p = Number(c.pricePerDay || 0);
              return p >= min && p <= max;
            });
          }

          displayCars(filteredCars);
        }

        function applyLocationFilter(){
          const val = document.getElementById('locationInput').value.trim();
          if(!val) return alert('Enter a location');
          filterCars();
        }

        async function detectLocationAndFilter(){
          if(!navigator.geolocation) return alert('Geolocation not supported');
          const loading = document.getElementById('loading');
          loading.style.display = 'block';
          navigator.geolocation.getCurrentPosition(async (pos)=>{
            const lat = pos.coords.latitude; const lon = pos.coords.longitude;
            try{
              const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
              const r = await fetch(url,{headers:{Accept:'application/json'}});
              const data = await r.json();
              const place = (data.address && (data.address.city || data.address.town || data.address.suburb || data.address.county)) || data.display_name || '';
              if(place){
                document.getElementById('locationInput').value = place;
                filterCars();
              } else {
                alert('Could not determine a named place for your location');
              }
            }catch(e){
              alert('Reverse geocoding failed');
            }finally{ loading.style.display = 'none'; }
          }, (err)=>{ loading.style.display = 'none'; alert('Permission denied or unable to access location'); }, {timeout:10000});
        }

        // geocode with caching helper
        async function geocodeCached(q){
          const cache = JSON.parse(sessionStorage.getItem('geocodeCache')||'{}');
          if(cache[q]) return cache[q];
          try{
            const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;
            const r = await fetch(url,{headers:{Accept:'application/json'}});
            const arr = await r.json();
            if(arr && arr.length){
              const coord = {lat:parseFloat(arr[0].lat), lon:parseFloat(arr[0].lon)};
              cache[q]=coord; sessionStorage.setItem('geocodeCache', JSON.stringify(cache));
              return coord;
            }
          }catch(e){console.warn('geocode failed',q,e)}
          return null;
        }

        function kmBetween(a,b){
          const toRad = v=>v*Math.PI/180;
          const R = 6371;
          const dLat = toRad(b.lat-a.lat); const dLon = toRad(b.lon-a.lon);
          const la = toRad(a.lat), lb = toRad(b.lat);
          const sinDLat = Math.sin(dLat/2)*Math.sin(dLat/2);
          const sinDLon = Math.sin(dLon/2)*Math.sin(dLon/2);
          const c = 2*Math.atan2(Math.sqrt(sinDLat + Math.cos(la)*Math.cos(lb)*sinDLon), Math.sqrt(1 - (sinDLat + Math.cos(la)*Math.cos(lb)*sinDLon)));
          return R*c;
        }

        async function applyRadiusAndFilters(){
          const radius = Number(document.getElementById('radiusKm')?.value || 0);
          if(!radius || radius <= 0) return filterCars();
          // get user location
          let userCoord = null;
          try{
            userCoord = await new Promise((res, rej)=>{
              if(navigator.geolocation){
                navigator.geolocation.getCurrentPosition(p=>res({lat:p.coords.latitude, lon:p.coords.longitude}), err=>rej(err), {timeout:10000});
              } else rej(new Error('No geolocation'));
            });
          }catch(e){
            // try to geocode the locationInput
            const loc = (document.getElementById('locationInput')?.value||'').trim();
            if(!loc) return alert('Allow location or enter a place to filter by radius');
            userCoord = await geocodeCached(loc);
            if(!userCoord) return alert('Could not determine your location');
          }

          const typeFilter = document.getElementById('typeFilter').value;
          const priceFilter = (document.getElementById('priceFilter')?.value || '').trim();
          let filtered = allCars;
          if(typeFilter) filtered = filtered.filter(c=>c.type===typeFilter);
          if(priceFilter){ const [min,max]=priceFilter.split('-').map(Number); filtered = filtered.filter(c=>{const p=Number(c.pricePerDay||0); return p>=min && p<=max}); }

          const out = [];
          for(const car of filtered){
            const areas = car.areas||[];
            let matched=false;
            for(const a of areas){
              const coord = await geocodeCached(a);
              if(coord){ const d = kmBetween(userCoord, coord); if(d <= radius){ matched=true; break; } }
            }
            if(matched) out.push(car);
          }
          displayCars(out);
        }

        function resetFilters(){
          document.getElementById('typeFilter').value = '';
          const pf = document.getElementById('priceFilter'); if(pf) pf.value = '';
          const li = document.getElementById('locationInput'); if(li) li.value = '';
          // reload original list
          displayCars(allCars);
        }

        function openBookingModal(carId, carModel, pricePerDay) {
          if (!isLoggedIn()) {
            alert("Please login to book a car");
            window.location.href = "/login";
            return;
          }

          document.getElementById("carId").value = carId;
          document.getElementById("bookingModal").style.display = "block";

          // Pre-fill dates if they were selected for availability check
          if (currentStartDate && currentEndDate) {
            document.getElementById("startDate").value = currentStartDate;
            document.getElementById("endDate").value = currentEndDate;
            calculateCost();
          }

          // Calculate total cost when dates change
          const startDate = document.getElementById("startDate");
          const endDate = document.getElementById("endDate");

          function calculateCost() {
            if (startDate.value && endDate.value) {
              const start = new Date(startDate.value);
              const end = new Date(endDate.value);
              const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));

              if (days > 0) {
                const total = days * pricePerDay;
                document.getElementById("totalCost").textContent = `$${total}`;
              }
            }
          }

          startDate.addEventListener("change", calculateCost);
          endDate.addEventListener("change", calculateCost);
        }

        // Close modal
        document.querySelector(".close").onclick = function () {
          document.getElementById("bookingModal").style.display = "none";
        };

        window.onclick = function (event) {
          const modal = document.getElementById("bookingModal");
          if (event.target == modal) {
            modal.style.display = "none";
          }
        };

        // Handle booking form submission
        document
          .getElementById("bookingForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();

            const token = localStorage.getItem("token");
            if (!token) {
              alert("Please login first");
              return;
            }

            const formData = new FormData(e.target);
            const pickupLocation = formData.get("pickupLocation");
            const dropoffLocation = formData.get("dropoffLocation");

            async function geocode(address) {
              const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(
                address
              )}`;
              try {
                const res = await fetch(url, {
                  headers: { Accept: "application/json" },
                });
                const arr = await res.json();
                if (arr && arr.length > 0) {
                  return {
                    lat: parseFloat(arr[0].lat),
                    lng: parseFloat(arr[0].lon),
                  };
                }
              } catch (err) {
                console.error("Geocode error", err);
              }
              return null;
            }

            function haversineKm(a, b) {
              const toRad = (v) => (v * Math.PI) / 180;
              const R = 6371; // km
              const dLat = toRad(b.lat - a.lat);
              const dLon = toRad(b.lng - a.lng);
              const lat1 = toRad(a.lat);
              const lat2 = toRad(b.lat);

              const sinDLat = Math.sin(dLat / 2) * Math.sin(dLat / 2);
              const sinDLon = Math.sin(dLon / 2) * Math.sin(dLon / 2);
              const aCalc = sinDLat + Math.cos(lat1) * Math.cos(lat2) * sinDLon;
              const c = 2 * Math.atan2(Math.sqrt(aCalc), Math.sqrt(1 - aCalc));
              return R * c;
            }

            const bookingData = {
              carId: formData.get("carId"),
              startDate: formData.get("startDate"),
              endDate: formData.get("endDate"),
              pickupLocation,
              dropoffLocation,
            };

            // Geocode addresses and compute distance (best-effort using Nominatim)
            let pickupCoord = null;
            let dropoffCoord = null;
            try {
              pickupCoord = await geocode(pickupLocation);
              dropoffCoord = await geocode(dropoffLocation);
            } catch (err) {
              console.warn("Geocoding failed", err);
            }

            if (pickupCoord && dropoffCoord) {
              const km = haversineKm(pickupCoord, dropoffCoord);
              bookingData.pickupLat = pickupCoord.lat;
              bookingData.pickupLng = pickupCoord.lng;
              bookingData.dropoffLat = dropoffCoord.lat;
              bookingData.dropoffLng = dropoffCoord.lng;
              bookingData.distanceKm = Math.round(km * 100) / 100; // two decimals

              // Update route preview
              const origin = encodeURIComponent(pickupLocation);
              const dest = encodeURIComponent(dropoffLocation);
              const mapsLink = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}`;
              document.getElementById(
                "routePreview"
              ).innerHTML = `Distance: <strong>${bookingData.distanceKm} km</strong> — <a href="${mapsLink}" target="_blank">Open in Google Maps</a>`;
            } else {
              document.getElementById("routePreview").textContent =
                "Could not determine exact route/distance (geocoding failed). A map link will still be provided.";
            }

            const messageDiv = document.getElementById("bookingMessage");

            try {
              const response = await fetch("/api/bookings", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify(bookingData),
              });

              const data = await response.json();

              if (response.ok) {
                messageDiv.innerHTML =
                  '<div class="success">Booking successful!</div>';
                setTimeout(() => {
                  document.getElementById("bookingModal").style.display =
                    "none";
                  loadCars(currentStartDate, currentEndDate); // Reload cars with current date filter to update availability
                }, 2000);
              } else {
                messageDiv.innerHTML = `<div class="error">${
                  data.message || "Booking failed"
                }</div>`;
              }
            } catch (error) {
              messageDiv.innerHTML =
                '<div class="error">Network error. Please try again.</div>';
            }
          });
      </script>

      <!-- Details Modal -->
      <div id="detailsModal" class="modal" style="display:none;">
        <div class="modal-content details-modal">
          <span class="details-close" style="cursor:pointer;">&times;</span>
          <h2 id="detailsTitle">Car Details</h2>
          <div id="detailsBody">
              <p id="detailsDescription"></p>
              <div id="fixedFields"></div>
              <ul id="featuresList"></ul>
              <div id="areasList"></div>
              <div id="imagesGallery" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;margin-top:8px;"></div>
              <div id="detailsMap" style="display:none;margin-top:12px;width:100%;height:320px;border-radius:10px;overflow:hidden"></div>
              <div id="detailsMessage" style="margin-top:12px"></div>
              <div style="margin-top:12px;display:flex;gap:8px">
                <button class="btn btn-primary btn-sm" onclick="checkCarNearMe()">Check Near Me</button>
                <button class="btn btn-secondary btn-sm" onclick="copyAreas()">Copy service areas</button>
              </div>
            </div>
        </div>
      </div>

      <script>
        async function openDetailsModal(carId) {
          try {
            const res = await fetch(`/api/cars/${carId}/details`);
            if (!res.ok) throw new Error('Failed to load details');
            const car = await res.json();

              // store current detailed car globally for "Check Near Me"
              window.currentDetailedCar = car;

              document.getElementById('detailsTitle').textContent = car.model || 'Car Details';
              document.getElementById('detailsDescription').textContent = car.description || '';

            // fixed fields
            const fixed = document.getElementById('fixedFields');
            fixed.innerHTML = '';
            if (car.fixedFields) {
              const rows = Object.entries(car.fixedFields).map(([k,v]) => `<div><strong>${k}:</strong> ${v}</div>`).join('');
              fixed.innerHTML = rows;
            }

            // features
            const fl = document.getElementById('featuresList');
            fl.innerHTML = '';
            if (car.features && car.features.length) {
              car.features.forEach(f => {
                const li = document.createElement('li');
                li.textContent = f;
                fl.appendChild(li);
              });
            }

            // areas
            const areas = document.getElementById('areasList');
            areas.innerHTML = '';
            if (car.areas && car.areas.length) {
              areas.innerHTML = '<strong>Service Areas:</strong> ' + car.areas.join(', ');
            }

            // images (grouped by position)
            const gallery = document.getElementById('imagesGallery');
            gallery.innerHTML = '';
            if (car.images && car.images.length) {
              car.images.forEach(group => {
                (group.urls || []).forEach(url => {
                  const img = document.createElement('img');
                  img.src = url;
                  img.alt = `${car.model} image`;
                  img.style.width = '100%';
                  img.style.height = '150px';
                  img.style.objectFit = 'cover';
                  img.style.borderRadius = '6px';
                  gallery.appendChild(img);
                });
              });
            }
            document.getElementById('detailsMessage').innerHTML = '';
            document.getElementById('detailsMessage').innerHTML = '';
            // initialize a small map showing service areas (geocode on demand)
            const mapHolder = document.getElementById('detailsMap');
            mapHolder.style.display = 'none';
            if (typeof L !== 'undefined' && car.areas && car.areas.length) {
              mapHolder.style.display = 'block';
              // clear previous map if present
              if (window.detailsMap) { window.detailsMap.remove(); window.detailsMap = null; }
              // create map
              const mapEl = document.createElement('div');
              mapEl.style.width = '100%'; mapEl.style.height = '320px';
              mapEl.id = 'detailsMapInner';
              mapHolder.innerHTML = '';
              mapHolder.appendChild(mapEl);
              window.detailsMap = L.map('detailsMapInner', { scrollWheelZoom:false }).setView([20,0], 2);
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap contributors'}).addTo(window.detailsMap);
              const group = L.featureGroup().addTo(window.detailsMap);
              // helper: geocode area name with caching
              const geocodeCache = JSON.parse(sessionStorage.getItem('geocodeCache')||'{}');
              for (let a of car.areas){
                try{
                  let coord = geocodeCache[a];
                  if(!coord){
                    const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(a)}`;
                    const r = await fetch(url,{headers:{Accept:'application/json'}});
                    const arr = await r.json();
                    if(arr && arr.length){ coord = {lat:parseFloat(arr[0].lat), lon:parseFloat(arr[0].lon)}; geocodeCache[a]=coord; sessionStorage.setItem('geocodeCache', JSON.stringify(geocodeCache)); }
                  }
                  if(coord){
                    const m = L.marker([coord.lat, coord.lon]).addTo(group).bindPopup(`<strong>${a}</strong>`);
                  }
                }catch(e){console.warn('Area geocode failed',a,e)}
              }
              if(group.getLayers().length) window.detailsMap.fitBounds(group.getBounds().pad(0.6));
            }

            document.getElementById('detailsModal').style.display = 'block';
          } catch (err) {
            console.error(err);
            alert('Failed to load car details');
          }
        }

        function copyAreas(){
          const car = window.currentDetailedCar;
          if(!car || !car.areas) return alert('No areas available');
          const text = car.areas.join(', ');
          navigator.clipboard?.writeText(text).then(()=>{
            const m = document.getElementById('detailsMessage');
            m.textContent = 'Service areas copied to clipboard';
            m.style.color = 'var(--color-primary)';
            setTimeout(()=> m.textContent = '',3000);
          });
        }

        async function checkCarNearMe(){
          const car = window.currentDetailedCar;
          const message = document.getElementById('detailsMessage');
          if(!car) return;
          if(!navigator.geolocation){
            message.textContent = 'Geolocation not supported by your browser';
            message.style.color = 'var(--color-danger)';
            return;
          }
          message.textContent = 'Detecting your location...';
          try{
            navigator.geolocation.getCurrentPosition(async (pos)=>{
              const lat = pos.coords.latitude;
              const lon = pos.coords.longitude;
              try{
                const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
                const r = await fetch(url, {headers:{Accept:'application/json'}});
                const data = await r.json();
                const place = (data.address && (data.address.city || data.address.town || data.address.suburb || data.address.county)) || data.display_name || '';
                if(!place){
                  message.textContent = 'Could not determine nearest place name';
                  message.style.color = 'var(--color-danger)';
                  return;
                }
                const locationLower = place.toLowerCase();
                const match = (car.areas||[]).find(a=>{
                  const al = a.toLowerCase();
                  return al.includes(locationLower) || locationLower.includes(al) || locationLower.split(/[,\s]+/).some(tok=>al.includes(tok));
                });
                if(match){
                  message.textContent = `Good news — this car serves your area (${match}).`;
                  message.style.color = 'var(--color-success)';
                } else {
                  message.textContent = `This car does not list your area (${place}). Available areas: ${ (car.areas||[]).join(', ') }`;
                  message.style.color = 'var(--color-danger)';
                }
              }catch(e){
                message.textContent = 'Reverse geocoding failed';
                message.style.color = 'var(--color-danger)';
              }
            }, (err)=>{
              message.textContent = 'Permission denied or unable to get location';
              message.style.color = 'var(--color-danger)';
            }, {timeout:10000});
          }catch(e){
            message.textContent = 'Error while detecting location';
            message.style.color = 'var(--color-danger)';
          }
        }

        document.querySelector('.details-close').onclick = function() {
          document.getElementById('detailsModal').style.display = 'none';
        };

        window.addEventListener('click', function(ev) {
          const modal = document.getElementById('detailsModal');
          if (ev.target === modal) modal.style.display = 'none';
        });
      </script>
    </main>

    <footer class="footer">
      <div class="footer-container">
        <p>&copy; 2025 AutoLease. All rights reserved.</p>
      </div>
    </footer>

    <script src="/js/auth.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/main.js"></script>
  </body>
</html>
